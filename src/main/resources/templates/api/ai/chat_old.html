<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
>
<head>
  <meta charset="UTF-8">
  <title>My Day</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/sidebar.css">
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="/css/materialize.css" type="text/css" rel="stylesheet" media="screen,projection"/>
    <link href="/css/style.css" type="text/css" rel="stylesheet" media="screen,projection"/>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link rel="stylesheet" href="/css/chat.css">
</head>
<body>
<main>
  <aside>
    <div th:replace="fragments/member-sidebar :: memberSidebar"></div>
  </aside>

  <section>
    <div class="chat-container">
      <div class="card" style="border-radius: 20px">
        <div class="card-content">
          <div class="card-title-box" style="display: flex; justify-content: space-between">
            <div class="card-title green-text text-darken-1"
                 style="font-weight: bold; text-align: center"
                 th:text="|${aiName}와 대화|">대화 제목
            </div>
            <button class="btn-flat btn-large transparent" type="button" name="clear"
                    onclick="closeChat()">
              <i class="material-icons black-text ">close</i>
            </button>
          </div>


          <div id="chat-window" class="chat-window">
            <!-- 초기 메시지 -->
            <div class="message-container ai">
              <div class="img-bubble">
                <img th:src="@{/images/ai/{aiId}.png(aiId=${aiId})}" alt="AI" class="ai-avatar">
                <div class="chat-bubble ai" th:text="${initialPrompt}">초기 질문</div>
                <span class="timestamp"></span>
              </div>
            </div>
          </div>

          <div class="card" style="border-radius: 20px">
            <div class="card-content">
              <form id="chat-form" th:object="${chatCount}">
                <div class="input-field">
                <textarea id="user-input" class="materialize-textarea"
                      placeholder="메시지를 입력하세요."></textarea>
                </div>

                <div class="action-row"
                     style="display: flex; align-items: center; justify-content: space-between">
                  <div id="chat-count-display" style="font-size: medium; font-weight: bold">
                    남은 메시지: 5
                  </div>

                  <div class="chat-buttons" style="display: flex; gap: 10px">
                    <button class="btn-floating grey darken-2" type="button" id="memo-button"
                            onclick="memo()">
                      <i class="material-icons left">save</i>
                    </button>
                    <button class="btn-floating green darken-3" type="submit" id="send-button">
                      <i class="material-icons left">send</i>
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </div>

        </div>
      </div>
    </div>

  </section>
</main>

<!--<th:block th:replace="~{fragments_test :: frg_script}"/>-->
<script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="/js/materialize.js"></script>
<script src="/js/init.js"></script>
<script>
  const chatHistory = [];
  const diaryId = [[${diaryId}]];
  const aiId = [[${aiId}]]
  let chatCount = 0;
  const MAX_CHAT_COUNT = 2;

  function getCurrentTime() {
    const now = new Date();
    const hours = now.getHours().toString().padStart(2, '0');
    const minutes = now.getMinutes().toString().padStart(2, '0');
    return `${hours}:${minutes}`;
  }

  // 남은 메시지 수 업데이트 함수
  function updateChatCountDisplay() {
    const remaining = MAX_CHAT_COUNT - chatCount;
    $('#chat-count-display').text(`남은 메시지: ${remaining}`)
  }

  // 전송 버튼 상태 업데이트 함수
  function updateSendButtonState() {
    if (chatCount >= MAX_CHAT_COUNT) {
      $('#send-button').prop('disabled', true).addClass('disabled');
      $('#memo-button').removeClass('grey').addClass('green');
      $('#user-input').prop('disabled', true);
      $('#chat-count-display').css('color', 'red').text('메시지 전송 한도에 도달했습니다.');
    }
  }

  $('#user-input').on('keydown', function (e) {
    if (e.keyCode === 13) {
      if (!e.shiftKey) { // 단순히 enter 키만 눌렀을 때
        e.preventDefault(); // 줄바꿈 방지
        $('#chat-form').submit(); // 폼 제출
      }
    }
  })

  $('#chat-form').on('submit', function (e) {
    e.preventDefault();

    if (chatCount >= MAX_CHAT_COUNT) {
      alert('메시지 전송 한도에 도달했습니다.');
      return;
    }

    const userMessage = $('#user-input').val().trim();
    if (!userMessage) {
      return;
    }

    $('#user-input').val('');
    const currentTime = getCurrentTime();

    // 채팅창에 사용자 메시지 추가
    $('#chat-window').append(`
        <div class="message-container user">
          <div class="time-bubble">
            <span class="timestamp">${currentTime}</span>
            <div class="chat-bubble user">${userMessage}</div>
          </div>
        </div>
    `);

    // 서버에 요청
    $.ajax({
      type: 'POST',
      url: '/api/ai/chat',
      contentType: 'application/json',
      data: JSON.stringify({
        diaryId: diaryId,
        chatHistory: chatHistory,
        userMessage: userMessage
      }),
      success: function (response) {
        const responseTime = getCurrentTime();
        $('#chat-window').append(`
          <div class="message-container ai">
             <div class="img-bubble">
                <img src="/images/ai/${aiId}.png" alt="AI" class="ai-avatar">
                <div class="chat-bubble ai">${response}</div>
                <span class="timestamp">${responseTime}</span>
             </div>
<!--             <span class="timestamp">${responseTime}</span>-->
          </div>
        `);
        chatHistory.push({user: userMessage, ai: response});
        // $('#user-input').val('');

        chatCount++;
        updateChatCountDisplay();
        updateSendButtonState();

        $('#chat-window').scrollTop($('#chat-window')[0].scrollHeight);
      },
      error: function () {
        alert("현재 대화가 어렵습니다.");
      }
    });
  });

  function closeChat() {
    alert('대화를 종료합니다.');
    window.location.href = `/record/${diaryId}`;
  }

  function memo() {
    fetch('/api/ai/chat/memo', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        diaryId: diaryId,
        chatHistory: chatHistory,
        userMessage: ''
      })
    })
    .then(response => {
      if (response.ok) {
        alert('대화 내용을 답징과 함께 저장합니다.');
        window.location.href = `/record/${diaryId}`;
      } else {
        alert('저장에 실패했습니다.');
      }
    })
  }

  // 페이지 로드 시 초기 상태 설정
  $(document).ready(function () {
    updateChatCountDisplay();
    // M.textareaAutoResize($('#user-input'));
    $('#user-input').trigger('autoresize');
    $('.timestamp').first().text(getCurrentTime());
  })
</script>
</body>
</html>